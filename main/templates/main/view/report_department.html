{% extends "base.html" %}
{% load static %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    body {
        background-color: #f9f9f9;
    }
    .direction-card {
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        background-color: #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    .indicator-card {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
    }
    .indicator-card:last-child {
        border-bottom: none;
    }
    .btn-toggle {
        font-weight: bold;
        font-size: 1.1rem;
        cursor: pointer;
        background-color: #e7f1ff;
        color: #0d6efd;
        border: none;
        width: 100%;
        text-align: left;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 0.5rem;
    }
</style>

<div class="container py-4">
    <h1 class="mb-4 text-center">{{ selected_year.year }} –∂—ã–ª“ì—ã –∫”©—Ä—Å–µ—Ç–∫—ñ—à—Ç–µ—Ä–≥–µ —à–æ–ª—É</h1>

    <form method="get" class="mb-3" id="filter-form">
        <div class="row g-2 align-items-end">
            <div class="col-md-auto">
                <label for="faculty" class="form-label">–§–∞–∫—É–ª—å—Ç–µ—Ç:</label>
                <select name="faculties" id="faculty-select" class="form-select">
                    <option value="all" {% if not selected_faculties %}selected{% endif %}>–í—Å–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã</option>
                    {% for faculty in faculties %}
                        <option value="{{ faculty.id }}" {% if faculty.id in selected_faculties %}selected{% endif %}>{{ faculty.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto">
                <label for="departments" class="form-label">–ö–∞—Ñ–µ–¥—Ä–∞:</label>
                <select name="departments" id="department-select" class="form-select" multiple>
                    {% for department in departments %}
                        <option value="{{ department.id }}" {% if department.id in selected_departments %}selected{% endif %}>{{ department.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto">
                <label for="year" class="form-label">–ñ—ã–ª:</label>
                <select name="year" id="year" class="form-select">
                    {% for year in years %}
                        <option value="{{ year.id }}" {% if year.id == selected_year.id %}selected{% endif %}>{{ year.year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto">
                <button type="submit" class="btn btn-primary">“ö–æ–ª–¥–∞–Ω—É</button>
            </div>
        </div>
    </form>

<a href="{% url 'export_report' selected_faculties.0 %}?year={{ selected_year.id  }}" class="btn btn-success btn-lg shadow">
    üìÑ –ï—Å–µ–ø—Ç—ñ Word —Ñ–æ—Ä–º–∞—Ç—ã–Ω–∞ –∂“Ø–∫—Ç–µ—É
</a>

<a href="{% url 'export_department_report_docx' selected_faculties.0 %}?year={{ selected_year.id }}{% for d in selected_departments %}&departments={{ d }}{% endfor %}" class="btn btn-success btn-lg shadow">
   üìÑ –ï—Å–µ–ø—Ç—ñ Word —Ñ–æ—Ä–º–∞—Ç—ã–Ω–∞ –∂“Ø–∫—Ç–µ—É
</a>



    {% for direction in data %}
        <div class="direction-card">
            <button class="btn btn-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#direction-{{ forloop.counter }}">
                üìÇ {{ direction.name }}
            </button>
            <div id="direction-{{ forloop.counter }}" class="collapse show px-3 pb-3">
                {% for main in direction.main_indicators %}
                    <div class="indicator-card">
                        <h5 class="mb-2">{{ main.code }} {{ main.name }} <small class="text-muted">({{ main.unit }})</small></h5>

                        {% if main.has_sub_indicators %}
                            <p class="text-end text-primary"><strong>–ë–∞—Ä–ª—ã“ì—ã: {{ main.sub_total_sum }}</strong></p>
                            {% for sub in main.sub_indicators %}
                                <div class="ms-3 mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span><strong>{{ sub.code }} {{ sub.name }}</strong> ({{ sub.unit }})</span>
                                        <span>
                                            {{ sub.total }}
                                            {% if sub.teachers %}
                                                <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#modal-sub-{{ main.code }}-{{ forloop.counter }}">üë•</button>
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>

                                <!-- Modal –¥–ª—è sub-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ -->
                                <div class="modal fade" id="modal-sub-{{ main.code }}-{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-scrollable">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">{{ sub.name }} ‚Äî –æ“õ—ã—Ç—É—à—ã–ª–∞—Ä</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <ul class="list-group">
                                                    {% for teacher, value in sub.teachers %}
                                                        <li class="list-group-item d-flex justify-content-between">
                                                            <span>{{ teacher }}</span>
                                                            <span>{{ value }}</span>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>{{ main.code }} {{ main.name }}</strong> ({{ main.unit }})</span>
                                <span>
                                    {{ main.total }}
                                    {% if main.teachers %}
                                        <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#modal-main-{{ main.code }}">üë•</button>
                                    {% endif %}
                                </span>
                            </div>

                            <!-- Modal –¥–ª—è main –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ -->
                            <div class="modal fade" id="modal-main-{{ main.code }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-scrollable">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">{{ main.name }} ‚Äî –æ“õ—ã—Ç—É—à—ã–ª–∞—Ä</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <ul class="list-group">
                                                {% for teacher, value in main.teachers %}
                                                    <li class="list-group-item d-flex justify-content-between">
                                                        <span>{{ teacher }}</span>
                                                        <span>{{ value }}</span>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
</div>

<script>
    document.getElementById("filter-form").addEventListener("change", function() {
        this.submit();
    });

    document.getElementById('faculty-select').addEventListener('change', function () {
        const facultyId = this.value;
        const departmentSelect = document.getElementById('department-select');
        departmentSelect.innerHTML = '';

        if (facultyId === 'all') {
            {% for department in departments %}
                let option = new Option('{{ department.name }}', '{{ department.id }}');
                option.selected = true;
                departmentSelect.appendChild(option);
            {% endfor %}
        } else {
            fetch(`/get_departments/${facultyId}/`)
                .then(response => response.json())
                .then(data => {
                    data.departments.forEach(dep => {
                        let option = new Option(dep.name, dep.id);
                        departmentSelect.appendChild(option);
                    });
                });
        }
    });
</script>
{% endblock %}
