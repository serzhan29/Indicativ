{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'main/css/index.css' %}">

<div style="padding-top: 20px;">
  <div class="dashboard-container">
    <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: —Ñ–∏–ª—å—Ç—Ä + —Å–ø–∏—Å–æ–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ -->
    <aside class="sidebar">
      <!-- –§–ò–õ–¨–¢–† –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ô -->
      <form method="GET" action="" class="filter-form">
        <div class="filter-group">
          <label for="direction">–ë–∞“ì—ã—Ç—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑</label>
          <select name="direction" id="direction">
            <option value="">–ë–∞—Ä–ª—ã“õ –±–∞“ì—ã—Ç—Ç–∞—Ä</option>
            {% for direction in directions %}
              <option
                value="{{ direction.id }}"
                {% if direction.id == selected_direction %}selected{% endif %}
              >{{ direction.name }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="filter-button">“ö–æ–ª–¥–∞–Ω—É</button>
      </form>

      <!-- –í–´–ë–û–† –ò–ù–î–ò–ö–ê–¢–û–†–û–í –° –ü–û–ò–°–ö–û–ú –ò –ì–ê–õ–û–ß–ö–ê–ú–ò -->
      <div class="indicator-section">
        <label class="indicator-section-title">–ö”©—Ä—Å–µ—Ç–∫—ñ—à—Ç–µ—Ä–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:</label>

        <!-- –ü–æ–∏—Å–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ -->
        <input
          type="text"
          id="indicatorSearch"
          placeholder="–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–¥—ã —ñ–∑–¥–µ—É..."
          class="indicator-search"
        >

        <!-- –°–µ—Ç–∫–∞ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ -->
        <div id="indicatorList" class="indicator-list">
          {% for indicator in year_values.0.main_indicators %}
            <label class="indicator-item">
              <div class="indicator-name">
                {{ indicator.code }} {{ indicator.name }}
              </div>
              <input
                type="checkbox"
                class="indicator-toggle"
                data-code="{{ indicator.code }}"
                {% if forloop.counter <= 6 %}checked{% endif %}
              >
            </label>
          {% endfor %}
        </div>
      </div>
    </aside>

    <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –≥—Ä–∞—Ñ–∏–∫–∏ -->
    <main class="main-content">
      <!-- –ó–ê–ì–û–õ–û–í–û–ö -->
      <h2 class="charts-header">
        üìä {{ teacher.get_full_name|default:teacher.username }} “Ø—à—ñ–Ω –Ω–µ–≥—ñ–∑–≥—ñ –∫”©—Ä—Å–µ—Ç–∫—ñ—à—Ç–µ—Ä –±–æ–π—ã–Ω—à–∞ –≥—Ä–∞—Ñ–∏–∫—Ç–µ—Ä
      </h2>

      <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <!-- –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ -->
      {% if year_values.0.main_indicators %}
        <div class="chart-grid" id="chartGrid">
          {% for main in year_values.0.main_indicators %}
            <div
              class="chart-card"
              data-code="{{ main.code }}"
              style="{% if forloop.counter <= 6 %}display: flex;{% else %}display: none;{% endif %}"
            >
              <div class="chart-info">
                <div
                  class="chart-title"
                  title="{{ main.code }} ‚Äî {{ main.name }}"
                >
                  {{ main.code }} ‚Äî {{ main.name }}
                </div>
                <div class="chart-unit">–ë—ñ—Ä–ª—ñ–∫: {{ main.unit }}</div>
              </div>

              <canvas id="chart-{{ forloop.counter }}" height="320"></canvas>
            </div>
          {% endfor %}
        </div>

        {% if year_values.0.main_indicators|length > 6 %}
          <div class="show-more-container">
            <button id="showMoreBtn" class="show-more-button">
              –ö”©–±—ñ—Ä–µ–∫ –∫”©—Ä—Å–µ—Ç—É
            </button>
          </div>
        {% endif %}
      {% else %}
        <p class="no-charts">–ì—Ä–∞—Ñ–∏–∫—Ç–µ—Ä –∂–æ“õ. –ï—Å–µ–ø—Ç–µ—Ä —Ç–æ–ª—Ç—ã—Ä—ã–ª–º–∞“ì–∞–Ω –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω.</p>
      {% endif %}
    </main>
  </div>
</div>

<!-- Inline-—Å—Ç–∏–ª–∏ –¥–∞–ª—å—à–µ –ª—É—á—à–µ –≤—ã–Ω–µ—Å—Ç–∏ –≤ CSS, –Ω–æ –æ—Å—Ç–∞–≤–ª—è—é —Å—Ä–∞–∑—É –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ -->
<link rel="stylesheet" href="{% static 'main/css/index.css' %}">

<!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
<script>
  // –ú–∞—Å—Å–∏–≤, –≤ –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω–∏–º –≤—Å–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã Chart.js
  const charts = [];
  {% for main in year_values.0.main_indicators %}
    (function() {
      const ctx = document.getElementById("chart-{{ forloop.counter }}").getContext("2d");
      const config = {
        type: "line",
        data: {
          labels: [{% for y in year_values %}"{{ y.year }}",{% endfor %}],
          datasets: [{
            label: "{{ main.name }}",
            data: [
              {% for y in year_values %}
                {% for m in y.main_indicators %}
                  {% if m.code == main.code %}
                    {{ m.value }},
                  {% endif %}
                {% endfor %}
              {% endfor %}
            ],
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            tension: 0.4,
            pointRadius: 3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: true } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "{{ main.unit }}" } },
            x: { title: { display: true, text: "–ñ—ã–ª–¥–∞—Ä" } }
          }
        }
      };
      const chartInstance = new Chart(ctx, config);
      chartInstance.code = "{{ main.code }}";
      charts.push(chartInstance);
    })();
  {% endfor %}

  // –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  const checkboxes = document.querySelectorAll('.indicator-toggle');
  const searchInput = document.getElementById('indicatorSearch');
  const showMoreBtn = document.getElementById('showMoreBtn');

  function updateChartVisibility() {
    const activeCodes = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.dataset.code);

    document.querySelectorAll('.chart-card').forEach(card => {
      const code = card.dataset.code;
      if (activeCodes.includes(code)) {
        if (card.style.display !== 'flex') {
          card.style.display = 'flex';
          const chartObj = charts.find(c => c.code === code);
          if (chartObj) chartObj.resize();
        }
      } else {
        if (card.style.display !== 'none') {
          card.style.display = 'none';
        }
      }
    });
  }

  function toggleShowMoreBtn() {
    if (!showMoreBtn) return;
    const anyBeyondSixChecked = Array.from(checkboxes)
      .slice(6)
      .some(cb => cb.checked);
    showMoreBtn.style.display = anyBeyondSixChecked ? 'inline-block' : 'none';
  }

  searchInput.addEventListener('input', () => {
    const term = searchInput.value.toLowerCase();
    document.querySelectorAll('.indicator-name').forEach(label => {
      label.parentElement.style.display = label.textContent.toLowerCase().includes(term) ? 'flex' : 'none';
    });
  });

  checkboxes.forEach(cb => cb.addEventListener('change', () => {
    updateChartVisibility();
    toggleShowMoreBtn();
  }));

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  updateChartVisibility();
  toggleShowMoreBtn();

  if (showMoreBtn) {
    showMoreBtn.addEventListener('click', () => {
      document.querySelectorAll('.chart-card').forEach(card => {
        if (card.style.display !== 'flex') {
          card.style.display = 'flex';
          const chartObj = charts.find(c => c.code === card.dataset.code);
          if (chartObj) chartObj.resize();
        }
      });
      showMoreBtn.style.display = 'none';
    });
  }
</script>
{% endblock %}
