{% extends "base.html" %}
{% load static %}
{% block title %}–ñ—ã–ª: {{ year }} - –±–∞—Ä–ª—ã“õ –±–∞“ì—ã—Ç—Ç–∞—Ä{% endblock %}
{% block content %}

<link rel="stylesheet" href="{% static 'main/css/main.css' %}">
<style>
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .page-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    /* –ë–ª–æ–∫ —Å–ø–∏—Å–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π */
    .switch-direction-container {
        position: sticky; /* –ß—Ç–æ–±—ã –±–ª–æ–∫ –±—ã–ª "–ª–∏–ø–∫–∏–º" */
        top: 20px; /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
        background: linear-gradient(135deg, #007bff, #66d9ff);
        padding: 20px;
        border-radius: 12px;
        color: white;
        min-width: 250px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        height: fit-content;
        z-index: 2; /* –ß—Ç–æ–±—ã –±–ª–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –±—ã–ª —Å–≤–µ—Ä—Ö—É */
    }

    /* –ù–æ–≤—ã–π –±–ª–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≥–æ–¥–æ–≤ */
    .switch-direction-container + .switch-direction-container {
        top: 500px; /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è –±–ª–æ–∫–∞ –≥–æ–¥–∞, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª –±–ª–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π */
        background: linear-gradient(135deg, #28a745, #66d97d); /* –î—Ä—É–≥–æ–π —Ñ–æ–Ω –¥–ª—è –±–ª–æ–∫–∞ –≥–æ–¥–∞ */
        z-index: 1; /* –ë–ª–æ–∫ –≥–æ–¥–æ–≤ –±—É–¥–µ—Ç –Ω–∏–∂–µ –±–ª–æ–∫–æ–≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π */
    }


    .switch-direction-container h4 {
        margin-bottom: 15px;
        font-size: 20px;
        border-bottom: 2px solid white;
        padding-bottom: 5px;
    }

    .switch-direction-container ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .switch-direction-container li {
        margin-bottom: 10px;
    }

    .switch-direction-container a {
        color: white;
        font-weight: bold;
        text-decoration: none;
        display: block;
        padding: 8px 12px;
        border-radius: 8px;
        transition: background-color 0.3s;
    }

    .switch-direction-container a:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .btn-download {
        display: inline-block;
        margin-top: 20px;
        width: 100%;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 600;
        color: white;
        background: linear-gradient(90deg, #00b894, #00ce7c);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: background 0.3s, transform 0.2s;
        box-shadow: 0 4px 6px rgba(0, 206, 124, 0.4);
    }

    /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    .btn-download:hover {
        background: linear-gradient(90deg, #00ce7c, #00b894);
        transform: scale(1.05);
    }

    /* –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
    .btn-download:active {
        transform: scale(0.98);
        background: linear-gradient(90deg, #00a86b, #00c473);
    }

    /* –ë–ª–æ–∫ –æ—Ç—á–µ—Ç–∞ (—É–∂–µ –±—ã–ª) */
    .report-container {
        flex: 1;
        background: linear-gradient(135deg, #007bff, #66d9ff);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    @media (max-width: 768px) {
        .page-container {
            flex-direction: column;
        }
    }
</style>

<div class="page-container" style="display: flex; gap: 20px;">
<div style="display: flex; flex-direction: column; gap: 20px;">
    <!-- –ë–ª–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π -->
    <div class="switch-direction-container">
        <h4>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</h4>
        <ul>
          {% for direction_item in directions %}
            {% if not current_direction or direction_item.id != current_direction.id %}
              <li>
                <a href="{% url 'teacher_report' direction_id=direction_item.id year_id=year.id %}" class="text-decoration-none">
                  {{ direction_item.name }}
                </a>
              </li>
            {% endif %}
          {% endfor %}
        </ul>
        <ul>
            <a href="{% url 'teacher_full_report_with_year' year_id=year.id %}">–ë–ê–†–õ–´“ö –ë–ê“í–´–¢–¢–ê–† - {{ year.year }}</a>
        </ul>
        <ul>
          {% if teacher.id and year.id %}
            <a href="{% url 'teacher_report_download' %}?year={{ year.id }}&teacher={{ teacher.id }}" class="btn btn-outline-primary btn-sm w-100">
              üìÑ Word-“õ–∞ –∂“Ø–∫—Ç–µ—É
            </a>
          {% endif %}
        </ul>
    </div>

    <!-- –ù–æ–≤—ã–π –±–ª–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≥–æ–¥–æ–≤ -->
    <div class="switch-direction-container" style="background: linear-gradient(135deg, #28a745, #66d97d);">
        <h4>–ñ—ã–ª–¥—ã –∞—É—ã—Å—Ç—ã—Ä—É:</h4>
        <ul>
          {% for year_item in all_years %}
            {% if year_item.id != year.id %}
              <li>
                <a href="{% url 'teacher_full_report_with_year' year_id=year_item.id %}" class="text-decoration-none" style="color: white">
                  {{ year_item.year }}
                </a>
              </li>
            {% endif %}
          {% endfor %}
        </ul>
    </div>
</div>


<div class="report-container">
    <div class="report-header">
        <div>
            <h3>–ñ—ã–ª: {{ year }}</h3>
        </div>
    </div>

    {% for direction_item, aggregated_data in all_aggregated_data.items %}
        <h3 style="margin-top: 30px;">{{ direction_item.name }}</h3>
        <table class="report-table">
            <thead>
                <tr>
                    <th>–ö–æ–¥</th>
                    <th>–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞—Ç–∞—É—ã</th>
                    <th>”®–ª—à–µ—É –±—ñ—Ä–ª—ñ–≥—ñ</th>
                    <th>–ö”©—Ä—Å–µ—Ç–∫—ñ—à —Å–∞–Ω—ã</th>
                </tr>
            </thead>
            <tbody>
                {% for data in aggregated_data %}
                <tr class="main-indicator">
                    <td>{{ data.main_indicator.code }}</td>
                    <td>{{ data.main_indicator.name }}</td>
                    <td>{{ data.main_indicator.unit }}</td>
                    <td>
                        {% if data.teacher_reports %}
                            <span class="total-value" data-default-value="{{ data.additional_value }}" style="color: #003366">{{ data.total_value }}</span>
                        {% else %}
                            <input
                                type="number"
                                class="editable {% if not year.editable %} not-editable {% endif %}"
                                data-type="additional"
                                data-id="{{ data.id }}"
                                {% if not year.editable %} disabled {% endif %}
                                min="0"
                                max="100"
                                step="1"
                                value="{{ data.additional_value }}"
                            >
                        {% endif %}
                    </td>
                </tr>
                {% if data.teacher_reports %}
                    {% for report in data.teacher_reports %}
                    <tr class="sub-indicator">
                        <td>{{ report.indicator.code }}</td>
                        <td>{{ report.indicator.name }}</td>
                        <td>{{ report.indicator.unit }}</td>
                        <td>
                            <input
                                type="number"
                                class="editable {% if not year.editable %} not-editable {% endif %}"
                                data-type="indicator"
                                data-id="{{ report.id }}"
                                {% if not year.editable %} disabled {% endif %}
                                min="0"
                                max="100"
                                step="1"
                                value="{{ report.value }}"
                            >
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}
</div>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".editable").forEach(input => {
            input.addEventListener("change", function () {
                let value = this.value.trim();
                let id = this.dataset.id;
                let type = this.dataset.type;

                if (!/^(100|[1-9]?\d?)$/.test(value)) {
                    this.value = this.dataset.defaultValue;
                    return;
                }

                fetch("/update_value/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({ id: id, value: value, type: type })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (type === "indicator") {
                            updateTotals();
                        }
                        console.log("–ó–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ");
                    }
                });
            });
        });

        function updateTotals() {
            document.querySelectorAll("tbody tr.main-indicator").forEach(row => {
                let sum = 0;
                let totalCell = row.querySelector(".total-value");

                let nextRow = row.nextElementSibling;
                while (nextRow && nextRow.classList.contains("sub-indicator")) {
                    let input = nextRow.querySelector("input");
                    if (input) {
                        sum += parseFloat(input.value) || 0;
                    }
                    nextRow = nextRow.nextElementSibling;
                }

                if (totalCell) {
                    totalCell.innerText = sum;
                }
            });
        }
    });
</script>

{% endblock %}
