{% extends "base.html" %}
{% load static %}
{% block breadcrumbs %}
  <li class="breadcrumb-item"><a href="{% url 'direction_list' %}">{{ direction.name }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'choose_year' direction_id=direction.id %}">Барлық жылдар</a></li>
  <li class="breadcrumb-item active" aria-current="page">{{ year.year }}</li>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'main/css/main.css' %}">
<link rel="stylesheet" href="{% static 'main/css/teacher_report.css' %}">

<div class="page-container" style="display: flex; gap: 20px;">
    <!-- Фиксированный блок со списком направлений -->
    <div class="switch-direction-container">
        <h4>Переключить направление:</h4>
        <ul>
          {% for direction_item in directions %}
            {% if direction_item.id != direction.id %}
              <li>
                <a href="{% url 'teacher_report' direction_id=direction_item.id year_id=year.id %}" class="text-decoration-none">
                  {{ direction_item.name }}
                </a>
              </li>
            {% endif %}
          {% endfor %}
        </ul>
        <ul>
            <a href="{% url 'teacher_full_report_with_year' year_id=year.id %}">БАРЛЫҚ БАҒЫТТАР - {{ year.year }}</a>
        </ul>
            <form action="{% url 'download_teacher_report' teacher_id=teacher.id direction_id=direction.id year_id=year.id %}" method="get">
                <button type="submit" class="btn-download">Есепті жүктеу</button>
            </form>
    </div>

    <!-- Блок с отчетом -->
    <div class="report-container">
        <div class="report-header">
            <div>
                <h2>{{ direction }}</h2>
                <h3>Жыл: {{ year }}</h3>
            </div>
        </div>

        <table class="report-table">
            <thead>
                <tr>
                    <th>Код</th>
                    <th>Индикатор атауы</th>
                    <th>Өлшеу бірлігі</th>
                    <th>Көрсеткіш саны</th>
                    <th>Файлдар</th>

                </tr>
            </thead>
            <tbody>
                {% for data in aggregated_data %}
                <tr class="main-indicator">
                    <td>{{ data.main_indicator.code }}</td>
                    <td>{{ data.main_indicator.name }}</td>
                    <td>{{ data.main_indicator.unit }}</td>
                    <td>
                        {% if data.teacher_reports %}
                            <span class="total-value" data-default-value="{{ data.additional_value }}" style="color: #003366">{{ data.total_value }}</span>
                        {% else %}
                            <input
                                type="number"
                                class="editable {% if not year.editable %} not-editable {% endif %}"
                                data-type="additional"
                                data-id="{{ data.id }}"
                                {% if not year.editable %} disabled {% endif %}
                                min="0"
                                max="100"
                                step="1"
                                value="{{ data.additional_value }}"
                            >
                        {% endif %}
                    </td>
                    <td>
                        <!-- Кнопка для открытия модального окна с файлами -->
                        <button
                            class="open-file-modal btn btn-sm btn-light"
                            data-id="{{ data.id }}"
                            data-name="{{ data.main_indicator.name }}"
                            data-type="main"
                            onclick="console.log('Button clicked!', this.dataset.id, this.dataset.name, this.dataset.type)"
                        >
                            Файлдар ({{ data.uploaded_works.count }})
                        </button>

                </tr>
                {% if data.teacher_reports %}
                    {% for report in data.teacher_reports %}
                    <tr class="sub-indicator">
                        <td>{{ report.indicator.code }}</td>
                        <td>{{ report.indicator.name }}</td>
                        <td>{{ report.indicator.unit }}</td>
                        <td>
                            <input
                                type="number"
                                class="editable {% if not year.editable %} not-editable {% endif %}"
                                data-type="indicator"
                                data-id="{{ report.id }}"
                                {% if not year.editable %} disabled {% endif %}
                                min="0"
                                max="100"
                                step="1"
                                value="{{ report.value }}"
                            >
                        </td>
                        <td>
                            <button
                                class="open-file-modal btn btn-sm btn-secondary"
                                data-id="{{ report.id }}"
                                data-name="{{ report.indicator.name }}"
                                data-type="sub"
                            >
                                Файлдар ({{ report.uploaded_files.count }})
                                {{ report.uploaded_files.uploaded_at }}
                            </button>
                        </td>

                    </tr>
                    {% endfor %}
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно для загрузки файлов -->
<div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="fileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="fileForm" enctype="multipart/form-data" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="fileModalLabel">Файлдар</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Жабу"></button>
        </div>
        <div class="modal-body">
          <input type="file" name="file" id="fileInput" class="form-control mb-3" required>
          <input type="hidden" name="report_id" id="modalReportId">
          <div id="uploadedFilesList"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Жүктеу</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'main/js/update_value.js' %}"></script>

{% endblock %}
